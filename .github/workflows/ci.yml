name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: macos-latest
            compiler: gcc
        include:
          - os: ubuntu-latest
            compiler: gcc
            cxx: g++-12
            cc: gcc-12
          - os: ubuntu-latest
            compiler: clang
            cxx: clang++-16
            cc: clang-16
          - os: macos-latest
            compiler: clang
            cxx: clang++
            cc: clang

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build valgrind
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get install -y g++-12
          else
            sudo apt-get install -y clang-16 clang-tidy-16
          fi

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DBUILD_TESTING=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Run unit tests
        run: ./build/unit_tests

      - name: Run multi-threaded tests
        run: ./build/mt_tests

  benchmarks:
    name: Benchmarks - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cxx: clang++-16
            cc: clang-16
          - os: macos-latest
            cxx: clang++
            cc: clang

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang-16

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DBUILD_BENCHMARKS=ON

      - name: Build benchmarks
        run: cmake --build build --config Release

      - name: Run benchmarks
        run: ./build/benchmarks --benchmark_min_time=0.1s

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.os }}
          path: |
            benchmark_*.json
          retention-days: 30

  sanitizers:
    name: Sanitizers - ${{ matrix.sanitizer }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        sanitizer: [address, thread, undefined]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang-16

      - name: Configure with ${{ matrix.sanitizer }} sanitizer
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=clang++-16 \
            -DCMAKE_C_COMPILER=clang-16 \
            -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -DCATCH_CONFIG_NO_POSIX_SIGNALS" \
            -DBUILD_TESTING=ON

      - name: Build
        run: cmake --build build

      - name: Run tests with ${{ matrix.sanitizer }} sanitizer
        run: |
          ./build/unit_tests
          ./build/mt_tests

  windows:
    name: Windows - MSVC
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (tests)
        run: |
          cmake -B build -DBUILD_TESTING=ON

      - name: Build tests
        run: cmake --build build --config Release

      - name: Run tests
        run: |
          ./build/Release/unit_tests.exe
          ./build/Release/mt_tests.exe

      - name: Configure CMake (benchmarks)
        run: |
          cmake -B build-bench -DBUILD_BENCHMARKS=ON

      - name: Build benchmarks
        run: cmake --build build-bench --config Release

      - name: Run benchmarks
        run: ./build-bench/Release/benchmarks.exe --benchmark_min_time=0.1s

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-windows
          path: |
            benchmark_*.json
          retention-days: 30
